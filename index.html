<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JWP787X20S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JWP787X20S');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusat Ajuan & Tracking - Ormawa UT Jakarta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Google Sign-In Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f5f5f5; }
        .font-heading { font-family: 'Poppins', sans-serif; }
        .kanban-column { min-width: 300px; }
        .popup-overlay { transition: opacity 0.3s ease; }
        .popup-content { transition: transform 0.3s ease; }
        .popup-overlay.hidden { display: none; }
        #login-button-container > div {
            margin: 0 auto !important;
        }
        /* Custom style for disabled button */
        .btn-disabled {
            cursor: not-allowed;
            background-color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <main>
        <!-- ===== Hero Section ===== -->
        <header class="relative h-[40vh] md:h-[50vh] max-h-[500px] flex items-center justify-center text-white bg-[#0d47a1]">
            <div class="relative z-10 text-center p-6">
                <h1 class="font-heading text-4xl md:text-6xl font-extrabold uppercase tracking-wider">
                    Pusat Ajuan
                </h1>
                <p class="mt-2 text-lg text-gray-200 max-w-3xl mx-auto">Ajukan dan Lacak Status Proposal Kegiatan Anda di Sini</p>
            </div>
        </header>

        <!-- ===== Main Content Section ===== -->
        <section class="py-12 md:py-20">
            <div class="container mx-auto px-6">

                <!-- Public Tracking Section -->
                <div id="public-tracking-section" class="max-w-2xl mx-auto mb-12 md:mb-16">
                    <div class="bg-white rounded-lg shadow-xl p-8">
                        <h2 class="font-heading text-2xl md:text-3xl font-bold text-[#0d47a1] text-center mb-6">Cek Status Proposal</h2>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="proposal-id-input" placeholder="Masukkan ID Proposal (e.g., PROP-00123)" class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#0d47a1]">
                            <button id="track-proposal-button" class="font-heading bg-[#0d47a1] text-white font-bold py-3 px-8 rounded-full uppercase hover:bg-[#1e88e5] transition-colors duration-300 flex-shrink-0">
                                Lacak
                            </button>
                        </div>
                        <div id="tracking-result" class="mt-6 text-center"></div>
                    </div>
                </div>

                <!-- Login Section -->
                <div id="login-section" class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow-xl p-8 text-center">
                        <svg class="w-16 h-16 mx-auto text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                        </svg>
                        <h2 class="font-heading text-2xl md:text-3xl font-bold text-[#0d47a1] mt-4 mb-4">Akses Dasbor Lengkap</h2>
                        <p class="text-gray-600 mb-8">Untuk mengajukan proposal baru atau melihat semua riwayat ajuan Anda, silakan login terlebih dahulu.</p>
                        <div id="login-button-container" class="flex justify-center"></div>
                        <p id="login-error" class="text-red-500 mt-4 hidden"></p>
                    </div>
                </div>

                <!-- Dashboard Section (Hidden by default) -->
                <div id="dashboard-section" class="hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h2 class="font-heading text-3xl md:text-4xl font-bold text-[#0d47a1]">Dasbor Ajuan Anda</h2>
                            <p id="user-greeting" class="text-gray-600"></p>
                        </div>
                        <div class="flex gap-4 w-full sm:w-auto">
                             <button id="new-proposal-button" class="font-heading bg-green-600 text-white font-bold py-3 px-6 rounded-full text-base uppercase hover:bg-green-700 transition-colors duration-300 w-full">
                                + Ajuan Baru
                            </button>
                            <button id="logout-button" class="font-heading bg-red-600 text-white font-bold py-3 px-6 rounded-full text-base uppercase hover:bg-red-700 transition-colors duration-300 w-full">
                                Logout
                            </button>
                        </div>
                    </div>

                    <div class="w-full overflow-x-auto pb-4">
                        <div id="kanban-container" class="flex gap-6">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
 
    <!-- New Proposal Modal -->
    <div id="new-proposal-modal" class="popup-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="popup-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 relative">
            <button id="close-new-proposal-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="font-heading text-2xl font-bold text-[#0d47a1] mb-6">Buat Ajuan Proposal Baru</h3>
            <form id="new-proposal-form">
                <div class="space-y-4">
                    <div>
                        <label for="proposal-name" class="block text-sm font-medium text-gray-700 text-left">Nama Pengaju</label>
                        <input type="text" id="proposal-name" name="proposal-name" required class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                    </div>
                    <div>
                        <label for="proposal-title" class="block text-sm font-medium text-gray-700 text-left">Judul Proposal</label>
                        <input type="text" id="proposal-title" name="proposal-title" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="proposal-ormawa" class="block text-sm font-medium text-gray-700 text-left">Nama UKM/Komunitas</label>
                        <input type="text" id="proposal-ormawa" name="proposal-ormawa" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="proposal-link" class="block text-sm font-medium text-gray-700 text-left">Link Dokumen Proposal</label>
                        <input type="url" id="proposal-link" name="proposal-link" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="https://docs.google.com/document/d/...">
                    </div>
                </div>
                 <p class="text-xs text-gray-500 mt-6 text-center">Dengan mengklik "Ajukan", Anda akan diarahkan ke Google Form untuk konfirmasi akhir. Data akan otomatis tercatat di Google Sheet.</p>
                <div class="mt-4 flex justify-end gap-4">
                    <button type="button" id="cancel-proposal-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300">Batal</button>
                    <button type="submit" class="bg-[#0d47a1] text-white font-bold py-2 px-4 rounded-full hover:bg-[#1e88e5]">Ajukan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="popup-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="popup-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 relative">
          <!-- Detail content will be injected here -->
      </div>
    </div>


    <footer class="bg-[#212121] text-gray-300 py-12">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-4 text-center md:text-left">
                    <img src="https://i.ibb.co.com/21LNqfQK/ORMAWA-Putih.png" alt="Logo Ormawa Putih" class="w-30 h-auto mx-auto md:mx-0">
                    <div class="mt-4 rounded-lg overflow-hidden">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3966.011686940333!2d106.85232007475224!3d-6.26217339372934!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e69f3a733615967%3A0x13d55c481535359!2sUniversitas%20Terbuka%20Jakarta!5e0!3m2!1sen!2sid!4v1727639538356!5m2!1sen!2sid" width="100%" height="200" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                    </div>
                </div>
                <div class="md:col-span-8 grid grid-cols-1 sm:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-heading text-xl font-bold text-white mb-4">Navigasi Cepat</h3>
                        <div class="flex flex-col space-y-2 text-sm">
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/syarat-ketentuan" class="hover:text-white hover:underline">📄 Syarat & Ketentuan</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/kebijakan-privasi" class="hover:text-white hover:underline">🔒 Kebijakan Privasi</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/disclaimer" class="hover:text-white hover:underline">⚠️ Disclaimer</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/panduan-kontributor" class="hover:text-white hover:underline">✍️ Panduan Kontributor</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/kontak-aspirasi" class="hover:text-white hover:underline">📬 Kontak</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-heading text-xl font-bold text-white mb-4">Info Kontak</h3>
                        <div class="text-sm space-y-2">
                            <p><strong>📍 Alamat:</strong> <a href="https://maps.app.goo.gl/A7nQzKA2vjbeav5i8" target="_blank" class="hover:text-white hover:underline">Jl. Jenderal Ahmad Yani No.43, RT.5/RW.4, Utan Kayu Sel., Kec. Matraman, Kota Jakarta Timur, DKI Jakarta 13320</a></p>
                            <p><strong>📞 Telepon:</strong> <a href="https://wa.link/nuxdjt" target="_blank" class="hover:text-white hover:underline">0822-7206-4457</a></p>
                            <p><strong>📧 Email:</strong> <a href="mailto:ormawautjakarta@gmail.com" class="hover:text-white hover:underline">ormawautjakarta@gmail.com</a></p>
                            <div class="flex space-x-4 mt-4">
                               <a href="https://www.instagram.com/ormawa.utjakarta" target="_blank" class="hover:text-white" title="Instagram">📸 Instagram</a>
                               <a href="https://www.tiktok.com/@ormawa.utjakarta" target="_blank" class="hover:text-white" title="TikTok">🎵 TikTok</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-xs">
                <p>© 2025 ORMAWA Universitas Terbuka Jakarta. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- KONFIGURASI ---
    const WEB_APP_BASE_URL = 'https://script.google.com/macros/s/AKfycbxP6OHFGFFb85GK3R6_hygKYXk6X5yFNlWTAu2MqtxP5ihb9H0nJTEwV4OINSrsnBQ8bw/exec'; 
    
    // -- CORRECTED SYNTAX --
    const USERS_SHEET_URL = `${WEB_APP_BASE_URL}?sheet=users`;
    const PROPOSALS_SHEET_URL = `${WEB_APP_BASE_URL}?sheet=proposals`; 

    const GOOGLE_CLIENT_ID = '10449530293-ra6ka58791u1f5javk771ssvpd0ifatn.apps.googleusercontent.com';
    
    const GOOGLE_FORM_PREFILL_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfNH1xtA8PS0mKJdV88zlKQGMs9dY8g3S0NM-sH7Z3vrK-cbg/viewform';
    const GOOGLE_FORM_ENTRIES = {
        name: 'entry.641917687',
        title: 'entry.926583392',
        ormawa: 'entry.1592310391',
        link: 'entry.1698715763',
        email: 'entry.176009538'
    };


    // --- UI Elements ---
    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const loginButtonContainer = document.getElementById('login-button-container');
    const logoutButton = document.getElementById('logout-button');
    const kanbanContainer = document.getElementById('kanban-container');
    const userGreeting = document.getElementById('user-greeting');
    const detailsModal = document.getElementById('details-modal');
    const loginError = document.getElementById('login-error');
    const newProposalModal = document.getElementById('new-proposal-modal');
    const newProposalButton = document.getElementById('new-proposal-button');
    const closeNewProposalModal = document.getElementById('close-new-proposal-modal');
    const cancelProposalButton = document.getElementById('cancel-proposal-button');
    const newProposalForm = document.getElementById('new-proposal-form');
    const publicTrackingSection = document.getElementById('public-tracking-section');
    const trackProposalButton = document.getElementById('track-proposal-button');
    const proposalIdInput = document.getElementById('proposal-id-input');
    const trackingResult = document.getElementById('tracking-result');

    // --- State ---
    let allProposalsData = [];
    let authorizedUsersData = [];
    let currentUser = null;

    // --- Status Configuration ---
    const statusConfig = {
        "Verifikasi Data": { color: 'border-gray-400', title: 'Verifikasi Data' },
        "Perlu Revisi": { color: 'border-yellow-500', title: 'Perlu Revisi' },
        "Sedang Pengajuan": { color: 'border-blue-500', title: 'Sedang Pengajuan' },
        "Mengetahui Direktur": { color: 'border-purple-500', title: 'Mengetahui Direktur'},
        "Selesai": { color: 'border-green-500', title: 'Selesai' }
    };

    // --- Google Sign-In Initialization ---
    window.onload = function () {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
            loginButtonContainer,
            { theme: "outline", size: "large", type: "standard", text: "signin_with", shape: "pill" } 
        );
        const loggedInEmail = sessionStorage.getItem('userEmail');
        const loggedInName = sessionStorage.getItem('userName');
        if (loggedInEmail && loggedInName) {
            handleLoginSuccess({ email: loggedInEmail, name: loggedInName });
        } else {
             google.accounts.id.prompt(); 
        }
    };

    // --- Login Logic ---
    async function handleCredentialResponse(response) {
        const userObject = jwt_decode(response.credential);
        await handleLoginSuccess(userObject);
    }

    async function handleLoginSuccess(userObject) {
        loginButtonContainer.innerHTML = '<p class="text-gray-600">Memverifikasi...</p>';
        loginError.classList.add('hidden');

        try {
            authorizedUsersData = await fetchData(USERS_SHEET_URL);
            const authorizedUser = authorizedUsersData.find(user => user.Email_Authorized.trim().toLowerCase() === userObject.email.toLowerCase());

            if (authorizedUser) {
                currentUser = {
                    email: userObject.email,
                    name: userObject.name,
                    ormawa: authorizedUser.Ormawa_UKM 
                };
                sessionStorage.setItem('userEmail', currentUser.email);
                sessionStorage.setItem('userName', currentUser.name);
                showDashboard();
            } else {
                handleLoginFailure('Akses ditolak. Email Anda tidak terdaftar.');
            }
        } catch (error) {
            console.error("Error during authorization:", error);
            handleLoginFailure('Gagal memverifikasi. Coba lagi nanti.');
        }
    }

    function handleLoginFailure(message) {
        loginError.textContent = message;
        loginError.classList.remove('hidden');
        google.accounts.id.renderButton(loginButtonContainer, { theme: "outline", size: "large" });
    }
    
    // --- Dashboard Logic ---
    async function showDashboard() {
        loginSection.style.display = 'none';
        publicTrackingSection.style.display = 'none';
        dashboardSection.style.display = 'block';
        userGreeting.textContent = `Selamat datang, ${currentUser.name}!`;
        
        document.getElementById('proposal-name').value = currentUser.name;
        document.getElementById('proposal-ormawa').value = currentUser.ormawa;

        try {
            kanbanContainer.innerHTML = '<p class="text-gray-600">Memuat data ajuan...</p>';
            allProposalsData = await fetchData(PROPOSALS_SHEET_URL);
            const userProposals = allProposalsData.filter(p => p.Email_Pengaju && p.Email_Pengaju.trim().toLowerCase() === currentUser.email.toLowerCase());
            renderKanbanBoard(userProposals);
        } catch (error) {
            console.error("Error fetching proposals:", error);
            kanbanContainer.innerHTML = '<p class="text-red-500">Gagal memuat data ajuan.</p>';
        }
    }

    // --- Kanban Board Rendering ---
    function renderKanbanBoard(proposals) {
        kanbanContainer.innerHTML = '';
        
        const proposalsByStatus = {};
        Object.keys(statusConfig).forEach(status => proposalsByStatus[status] = []);
        proposals.forEach(p => {
            if (p.Status && proposalsByStatus[p.Status.trim()]) {
                proposalsByStatus[p.Status.trim()].push(p);
            }
        });

        Object.keys(statusConfig).forEach(statusKey => {
            const columnConfig = statusConfig[statusKey];
            const columnEl = document.createElement('div');
            columnEl.className = 'kanban-column flex-shrink-0';
            columnEl.innerHTML = `<h3 class="font-heading text-lg font-bold text-gray-700 bg-gray-200 p-3 rounded-t-lg">${columnConfig.title}</h3><div class="p-4 bg-gray-100 rounded-b-lg space-y-4 h-full min-h-[150px]"></div>`;
            
            const columnContent = columnEl.querySelector('.p-4');
            const proposalsInColumn = proposalsByStatus[statusKey];

            if (proposalsInColumn.length === 0) {
                columnContent.innerHTML = '<p class="text-sm text-gray-400 italic text-center pt-4">Tidak ada ajuan</p>';
            } else {
                proposalsInColumn.forEach(proposal => {
                    const card = document.createElement('div');
                    card.className = `bg-white p-4 rounded-md shadow-sm border-l-4 ${columnConfig.color} cursor-pointer hover:shadow-md transition-shadow`;
                    card.dataset.id = proposal.Proposal_ID;
                    card.innerHTML = `<p class="text-xs text-gray-500 font-mono">${proposal.Proposal_ID}</p><p class="font-bold text-gray-800 mt-1">${proposal.Judul_Proposal}</p><p class="text-sm text-gray-500 mt-1">${proposal.Ormawa_UKM}</p>`;
                    card.addEventListener('click', () => showDetailsModal(proposal.Proposal_ID));
                    columnContent.appendChild(card);
                });
            }
            kanbanContainer.appendChild(columnEl);
        });
    }

    // --- MODIFIED: showDetailsModal ---
    function showDetailsModal(id) {
        const proposalData = allProposalsData.find(p => p.Proposal_ID === id);
        if (!proposalData) return;

        // NEW: Check if the status is "Perlu Revisi" to show the button
        const isRevisionNeeded = proposalData.Status.trim() === "Perlu Revisi";
        const revisionButtonHTML = `
            <div class="mt-6 pt-4 border-t text-center">
                <p class="text-sm text-gray-600 mb-3">Setelah Anda memperbaiki dokumen, klik tombol di bawah ini untuk mengirim ulang proposal Anda untuk diverifikasi.</p>
                <button id="revision-submit-button" data-id="${proposalData.Proposal_ID}" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-full hover:bg-blue-700 transition-colors">
                    Konfirmasi Selesai Revisi & Ajukan Ulang
                </button>
            </div>
        `;

        const content = `
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-800" onclick="document.getElementById('details-modal').classList.add('hidden')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="font-heading text-2xl font-bold text-[#0d47a1] mb-2">Detail Ajuan: ${proposalData.Proposal_ID}</h3>
            <p class="text-lg text-gray-700 mb-6">${proposalData.Judul_Proposal}</p>
            <div class="space-y-2 text-sm">
              <p><strong>Ormawa/UKM:</strong> ${proposalData.Ormawa_UKM}</p>
              <p><strong>Tanggal Diajukan:</strong> ${formatDateTime(proposalData.Tgl_Diajukan)}</p>
              <p><strong>Status Saat Ini:</strong> ${proposalData.Status}</p>
              ${proposalData.Link_Dokumen ? `<p><strong>Dokumen:</strong> <a href="${proposalData.Link_Dokumen}" target="_blank" class="text-blue-600 hover:underline">Lihat & Perbaiki Dokumen</a></p>` : ''}
            </div>
            ${(proposalData.Catatan_Revisi && proposalData.Catatan_Revisi.trim()) ? `<div class="mt-4 pt-4 border-t"><p class="font-semibold text-gray-800">Catatan Revisi:</p><p class="text-yellow-800 bg-yellow-50 p-3 rounded-md mt-2">${proposalData.Catatan_Revisi}</p></div>` : ''}
            ${isRevisionNeeded ? revisionButtonHTML : ''}
        `;
        detailsModal.querySelector('.popup-content').innerHTML = content;
        
        // NEW: Add event listener if the button exists
        if (isRevisionNeeded) {
            document.getElementById('revision-submit-button').addEventListener('click', handleRevisionSubmit);
        }

        detailsModal.classList.remove('hidden');
    }
    
    // --- NEW: handleRevisionSubmit function ---
    async function handleRevisionSubmit(event) {
        const button = event.target;
        const proposalId = button.dataset.id;

        // Disable button to prevent multiple clicks
        button.textContent = 'Mengupdate...';
        button.disabled = true;
        button.classList.add('btn-disabled');

        try {
            const response = await fetch(WEB_APP_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // Apps Script requires this header for POST
                },
                body: JSON.stringify({
                    proposalId: proposalId,
                    newStatus: 'Verifikasi Data' // The status to revert to
                })
            });

            const result = await response.json();

            if (result.status === 'success') {
                alert('Berhasil! Proposal Anda telah diajukan ulang untuk verifikasi.');
                closeAllModals();
                // Refresh the dashboard to show the updated data
                await showDashboard();
            } else {
                throw new Error(result.message || 'Gagal memperbarui status.');
            }

        } catch (error) {
            console.error('Error submitting revision:', error);
            alert(`Terjadi kesalahan: ${error.message}`);
            // Re-enable the button on error
            button.textContent = 'Konfirmasi Selesai Revisi & Ajukan Ulang';
            button.disabled = false;
            button.classList.remove('btn-disabled');
        }
    }


    // --- Public Tracking Logic ---
    async function trackPublicProposal() {
        const proposalID = proposalIdInput.value.trim().toUpperCase();
        if (!proposalID) {
            trackingResult.innerHTML = `<p class="text-red-500">Silakan masukkan ID Proposal.</p>`;
            return;
        }

        trackingResult.innerHTML = `<p class="text-gray-600">Mencari...</p>`;

        try {
            if (allProposalsData.length === 0) {
                allProposalsData = await fetchData(PROPOSALS_SHEET_URL);
            }
            
            const proposal = allProposalsData.find(p => p.Proposal_ID && p.Proposal_ID.trim().toUpperCase() === proposalID);

            if (proposal) {
                const statusInfo = statusConfig[proposal.Status.trim()] || {color: 'border-gray-500'};
                trackingResult.innerHTML = `
                    <div class="bg-gray-50 border-l-4 ${statusInfo.color} p-4 rounded-md text-left">
                        <p class="font-bold text-lg text-gray-800">${proposal.Judul_Proposal}</p>
                        <p class="text-sm text-gray-500">${proposal.Ormawa_UKM}</p>
                        <p class="mt-4"><strong>Status Saat Ini:</strong> <span class="font-bold">${proposal.Status}</span></p>
                    </div>
                `;
            } else {
                trackingResult.innerHTML = `<p class="text-red-500">Proposal dengan ID "${proposalID}" tidak ditemukan.</p>`;
            }
        } catch (error) {
            console.error("Error during public tracking:", error);
            trackingResult.innerHTML = `<p class="text-red-500">Gagal mengambil data. Coba lagi nanti.</p>`;
        }
    }


    // --- Modal Logic ---
    function openNewProposalModal() { newProposalModal.classList.remove('hidden'); }
    function closeAllModals() {
        newProposalModal.classList.add('hidden');
        detailsModal.classList.add('hidden');
    }

    // --- Form Submission ---
    newProposalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('proposal-name').value;
        const title = document.getElementById('proposal-title').value;
        const ormawa = document.getElementById('proposal-ormawa').value;
        const link = document.getElementById('proposal-link').value;
        const prefilledUrl = `${GOOGLE_FORM_PREFILL_URL}?usp=pp_url&${GOOGLE_FORM_ENTRIES.name}=${encodeURIComponent(name)}&${GOOGLE_FORM_ENTRIES.title}=${encodeURIComponent(title)}&${GOOGLE_FORM_ENTRIES.ormawa}=${encodeURIComponent(ormawa)}&${GOOGLE_FORM_ENTRIES.link}=${encodeURIComponent(link)}&${GOOGLE_FORM_ENTRIES.email}=${encodeURIComponent(currentUser.email)}`;
        window.open(prefilledUrl, '_blank');
        closeAllModals();
        newProposalForm.reset();
        document.getElementById('proposal-name').value = currentUser.name;
        document.getElementById('proposal-ormawa').value = currentUser.ormawa;
    });


    // --- Utility Functions ---
    // NEW: Function to format date and time
    function formatDateTime(isoString) {
        if (!isoString || isoString.trim() === '') {
            return 'Tidak ada tanggal';
        }
        try {
            const date = new Date(isoString);
            // Check for invalid date
            if (isNaN(date.getTime())) {
                return isoString; // Return original string if it's not a valid date
            }

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}/${month}/${year} ${hours}:${minutes}`;
        } catch (error) {
            console.error("Could not format date:", isoString, error);
            return isoString; // Return original string on error
        }
    }

    async function fetchData(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
        const data = await response.json();
        if (data.status === 'error') throw new Error(`API Error: ${data.message}`);
        return data;
    }

    // --- Event Listeners ---
    newProposalButton.addEventListener('click', openNewProposalModal);
    closeNewProposalModal.addEventListener('click', closeAllModals);
    cancelProposalButton.addEventListener('click', closeAllModals);
    trackProposalButton.addEventListener('click', trackPublicProposal);
    logoutButton.addEventListener('click', () => {
        sessionStorage.clear();
        currentUser = null;
        google.accounts.id.disableAutoSelect();
        location.reload();
    });
    detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeAllModals(); });
    newProposalModal.addEventListener('click', (e) => { if (e.target === newProposalModal) closeAllModals(); });
});
</script>

</body>
</html>

