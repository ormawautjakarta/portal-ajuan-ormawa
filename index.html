<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JWP787X20S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JWP787X20S');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusat Ajuan & Tracking - Ormawa UT Jakarta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Google Sign-In Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f5f5f5; }
        .font-heading { font-family: 'Poppins', sans-serif; }
        .kanban-column { min-width: 300px; }
        .popup-overlay { transition: opacity 0.3s ease; }
        .popup-content { transition: transform 0.3s ease; }
        .popup-overlay.hidden { display: none; }
        #login-button-container > div {
            margin: 0 auto !important;
        }
        /* Custom style for disabled button */
        .btn-disabled {
            cursor: not-allowed;
            background-color: #9ca3af; /* gray-400 */
            opacity: 0.7;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <main>
        <!-- ===== Hero Section ===== -->
        <header class="relative h-[40vh] md:h-[50vh] max-h-[500px] flex items-center justify-center text-white bg-[#0d47a1]">
            <div class="relative z-10 text-center p-6">
                <h1 class="font-heading text-4xl md:text-6xl font-extrabold uppercase tracking-wider">
                    Pusat Ajuan
                </h1>
                <p class="mt-2 text-lg text-gray-200 max-w-3xl mx-auto">Ajukan dan Lacak Status Proposal Kegiatan Anda di Sini</p>
            </div>
        </header>

        <!-- ===== Main Content Section ===== -->
        <section class="py-12 md:py-20">
            <div class="container mx-auto px-6">

                <!-- Public Tracking Section -->
                <div id="public-tracking-section" class="max-w-2xl mx-auto mb-12 md:mb-16">
                    <div class="bg-white rounded-lg shadow-xl p-8">
                        <h2 class="font-heading text-2xl md:text-3xl font-bold text-[#0d47a1] text-center mb-6">Cek Status Proposal</h2>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="proposal-id-input" placeholder="Masukkan ID Proposal (e.g., PROP-00123)" class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#0d47a1]">
                            <button id="track-proposal-button" class="font-heading bg-[#0d47a1] text-white font-bold py-3 px-8 rounded-full uppercase hover:bg-[#1e88e5] transition-colors duration-300 flex-shrink-0">
                                Lacak
                            </button>
                        </div>
                        <div id="tracking-result" class="mt-6 text-center"></div>
                    </div>
                </div>

                <!-- Login Section -->
                <div id="login-section" class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow-xl p-8 text-center">
                        <svg class="w-16 h-16 mx-auto text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                        </svg>
                        <h2 class="font-heading text-2xl md:text-3xl font-bold text-[#0d47a1] mt-4 mb-4">Akses Dasbor Lengkap</h2>
                        <p class="text-gray-600 mb-8">Untuk mengajukan proposal baru atau melihat semua riwayat ajuan Anda, silakan login terlebih dahulu.</p>
                        <div id="login-button-container" class="flex justify-center"></div>
                        <p id="login-error" class="text-red-500 mt-4 hidden"></p>
                    </div>
                </div>

                <!-- Dashboard Section (Hidden by default) -->
                <div id="dashboard-section" class="hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h2 class="font-heading text-3xl md:text-4xl font-bold text-[#0d47a1]">Dasbor Ajuan Anda</h2>
                            <p id="user-greeting" class="text-gray-600"></p>
                        </div>
                        <div class="flex gap-4 w-full sm:w-auto">
                             <button id="new-proposal-button" class="font-heading bg-green-600 text-white font-bold py-3 px-6 rounded-full text-base uppercase hover:bg-green-700 transition-colors duration-300 w-full">
                                + Ajuan Baru
                            </button>
                            <button id="logout-button" class="font-heading bg-red-600 text-white font-bold py-3 px-6 rounded-full text-base uppercase hover:bg-red-700 transition-colors duration-300 w-full">
                                Logout
                            </button>
                        </div>
                    </div>

                    <div class="w-full overflow-x-auto pb-4">
                        <div id="kanban-container" class="flex gap-6">
                            <!-- Kolom akan dibuat oleh JS -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
 
    <!-- New Proposal Modal -->
    <div id="new-proposal-modal" class="popup-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="popup-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 relative">
            <button id="close-new-proposal-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="font-heading text-2xl font-bold text-[#0d47a1] mb-6">Buat Ajuan Proposal Baru</h3>
            <form id="new-proposal-form">
                <div class="space-y-4">
                    <div>
                        <label for="proposal-name" class="block text-sm font-medium text-gray-700 text-left">Nama Pengaju</label>
                        <input type="text" id="proposal-name" name="proposal-name" required class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                    </div>
                    <div>
                        <label for="proposal-title" class="block text-sm font-medium text-gray-700 text-left">Judul Proposal</label>
                        <input type="text" id="proposal-title" name="proposal-title" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="proposal-ormawa" class="block text-sm font-medium text-gray-700 text-left">Nama UKM/Komunitas</label>
                        <input type="text" id="proposal-ormawa" name="proposal-ormawa" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>

                    <!-- Jenis Ajuan Dropdown -->
                    <div>
                        <label for="proposal-type" class="block text-sm font-medium text-gray-700 text-left">Jenis Ajuan</label>
                        <select id="proposal-type" name="proposal-type" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="" disabled selected>-- Pilih Jenis Ajuan --</option>
                            <option value="Peminjaman Aset">Peminjaman Aset</option>
                            <option value="Pendanaan">Pendanaan</option>
                            <option value="Pendirian UKM">Pendirian UKM</option>
                            <!-- Tambahkan opsi lain jika perlu -->
                        </select>
                    </div>
                    
                    <div>
                        <label for="proposal-link" class="block text-sm font-medium text-gray-700 text-left">Link Dokumen Proposal</label>
                        <input type="url" id="proposal-link" name="proposal-link" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="https://docs.google.com/document/d/...">
                    </div>
                </div>
                 <p class="text-xs text-gray-500 mt-6 text-center">Dengan mengklik "Ajukan", Anda akan diarahkan ke Google Form untuk konfirmasi akhir. Data akan otomatis tercatat di Google Sheet.</p>
                <div class="mt-4 flex justify-end gap-4">
                    <button type="button" id="cancel-proposal-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300">Batal</button>
                    <button type="submit" class="bg-[#0d47a1] text-white font-bold py-2 px-4 rounded-full hover:bg-[#1e88e5]">Ajukan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="popup-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="popup-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 relative">
          <!-- Detail content will be injected here by JS -->
      </div>
    </div>


    <footer class="bg-[#212121] text-gray-300 py-12">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-4 text-center md:text-left">
                    <img src="https://i.ibb.co.com/21LNqfQK/ORMAWA-Putih.png" alt="Logo Ormawa Putih" class="w-30 h-auto mx-auto md:mx-0">
                    <div class="mt-4 rounded-lg overflow-hidden">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3966.011686940333!2d106.85232007475224!3d-6.26217339372934!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e69f3a733615967%3A0x13d55c481535359!2sUniversitas%20Terbuka%20Jakarta!5e0!3m2!1sen!2sid!4v1727639538356!5m2!1sen!2sid" width="100%" height="200" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                    </div>
                </div>
                <div class="md:col-span-8 grid grid-cols-1 sm:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-heading text-xl font-bold text-white mb-4">Navigasi Cepat</h3>
                        <div class="flex flex-col space-y-2 text-sm">
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/syarat-ketentuan" class="hover:text-white hover:underline">üìÑ Syarat & Ketentuan</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/kebijakan-privasi" class="hover:text-white hover:underline">üîí Kebijakan Privasi</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/disclaimer" class="hover:text-white hover:underline">‚ö†Ô∏è Disclaimer</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/profil/tentang-website/panduan-kontributor" class="hover:text-white hover:underline">‚úçÔ∏è Panduan Kontributor</a>
                             <a href="https://sites.google.com/view/ormawa-ut-jakarta/kontak-aspirasi" class="hover:text-white hover:underline">üì¨ Kontak</a>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-heading text-xl font-bold text-white mb-4">Info Kontak</h3>
                        <div class="text-sm space-y-2">
                            <p><strong>üìç Alamat:</strong> <a href="https://maps.app.goo.gl/A7nQzKA2vjbeav5i8" target="_blank" class="hover:text-white hover:underline">Jl. Jenderal Ahmad Yani No.43, RT.5/RW.4, Utan Kayu Sel., Kec. Matraman, Kota Jakarta Timur, DKI Jakarta 13320</a></p>
                            <p><strong>üìû Telepon:</strong> <a href="https://wa.link/nuxdjt" target="_blank" class="hover:text-white hover:underline">0822-7206-4457</a></p>
                            <p><strong>üìß Email:</strong> <a href="mailto:ormawautjakarta@gmail.com" class="hover:text-white hover:underline">ormawautjakarta@gmail.com</a></p>
                            <div class="flex space-x-4 mt-4">
                               <a href="https://www.instagram.com/ormawa.utjakarta" target="_blank" class="hover:text-white" title="Instagram">üì∏ Instagram</a>
                               <a href="https://www.tiktok.com/@ormawa.utjakarta" target="_blank" class="hover:text-white" title="TikTok">üéµ TikTok</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-xs">
                <p>¬© 2025 ORMAWA Universitas Terbuka Jakarta. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- KONFIGURASI ---
    const WEB_APP_BASE_URL = 'https://script.google.com/macros/s/AKfycbxP6OHFGFFb85GK3R6_hygKYXk6X5yFNlWTAu2MqtxP5ihb9H0nJTEwV4OINSrsnBQ8bw/exec'; 
    
    const USERS_SHEET_URL = `${WEB_APP_BASE_URL}?sheet=users`;
    const PROPOSALS_SHEET_URL = `${WEB_APP_BASE_URL}?sheet=proposals`; 

    const GOOGLE_CLIENT_ID = '10449530293-ra6ka58791u1f5javk771ssvpd0ifatn.apps.googleusercontent.com';
    
    const GOOGLE_FORM_PREFILL_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfNH1xtA8PS0mKJdV88zlKQGMs9dY8g3S0NM-sH7Z3vrK-cbg/viewform';
    
    // !!! PENTING: GANTI ID ENTRY DI BAWAH INI !!!
    const GOOGLE_FORM_ENTRIES = {
        name: 'entry.641917687',    // ID untuk Nama Pengaju
        title: 'entry.926583392',   // ID untuk Judul Proposal
        ormawa: 'entry.1592310391', // ID untuk Nama UKM/Komunitas
        link: 'entry.1698715763',   // ID untuk Link Dokumen
        email: 'entry.176009538',  // ID untuk Email Pengaju (tersembunyi?)
        type: 'entry.426297314'   // ID untuk Jenis Ajuan (Pastikan ini benar!)
    };


    // --- UI Elements ---
    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const loginButtonContainer = document.getElementById('login-button-container');
    const logoutButton = document.getElementById('logout-button');
    const kanbanContainer = document.getElementById('kanban-container');
    const userGreeting = document.getElementById('user-greeting');
    const detailsModal = document.getElementById('details-modal');
    const loginError = document.getElementById('login-error');
    const newProposalModal = document.getElementById('new-proposal-modal');
    const newProposalButton = document.getElementById('new-proposal-button');
    const closeNewProposalModal = document.getElementById('close-new-proposal-modal');
    const cancelProposalButton = document.getElementById('cancel-proposal-button');
    const newProposalForm = document.getElementById('new-proposal-form');
    const publicTrackingSection = document.getElementById('public-tracking-section');
    const trackProposalButton = document.getElementById('track-proposal-button');
    const proposalIdInput = document.getElementById('proposal-id-input');
    const trackingResult = document.getElementById('tracking-result');

    // --- State ---
    let allProposalsData = [];
    let authorizedUsersData = [];
    let currentUser = null;

    // --- Status Configuration (Sudah Termasuk ACC Direktur) ---
    const statusConfig = {
        "Verifikasi Data": { color: 'border-gray-400', title: 'Verifikasi Data' },
        "Perlu Revisi": { color: 'border-yellow-500', title: 'Perlu Revisi' },
        "Sedang Pengajuan": { color: 'border-blue-500', title: 'Sedang Pengajuan' },
        "ACC Direktur": { color: 'border-cyan-500', title: 'ACC Direktur'}, 
        "Selesai": { color: 'border-green-500', title: 'Selesai' }
    };

    // --- Inisialisasi Google Sign-In ---
    window.onload = function () {
        try {
            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                loginButtonContainer,
                { theme: "outline", size: "large", type: "standard", text: "signin_with", shape: "pill" } 
            );
            checkSession(); // Panggil fungsi untuk cek sesi
        } catch (error) {
            console.error("Gagal inisialisasi Google Sign-In:", error);
            handleLoginFailure("Gagal memuat sistem login. Coba refresh halaman.");
        }
    };
    
    // --- Cek Sesi Login ---
    async function checkSession() {
        const loggedInEmail = sessionStorage.getItem('userEmail');
        const loggedInName = sessionStorage.getItem('userName');
        if (loggedInEmail && loggedInName) {
            console.log("Sesi ditemukan, mencoba login otomatis...");
            // Validasi ulang data pengguna (opsional tapi bagus)
            await handleLoginSuccess({ email: loggedInEmail, name: loggedInName }); 
        } else {
             console.log("Tidak ada sesi, menampilkan prompt login.");
             google.accounts.id.prompt((notification) => {
                if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                    // console.log("Prompt tidak ditampilkan atau dilewati.");
                    // Mungkin perlu menampilkan tombol login secara manual jika prompt gagal
                }
             }); 
        }
    }


    // --- Logika Login ---
    async function handleCredentialResponse(response) {
       console.log("Menerima kredensial Google...");
        try {
            const userObject = jwt_decode(response.credential);
            await handleLoginSuccess(userObject);
        } catch (error) {
            console.error("Error decoding token atau saat login:", error);
            handleLoginFailure("Gagal memproses login Anda.");
        }
    }

    async function handleLoginSuccess(userObject) {
        if (!userObject || !userObject.email) {
             console.error("Objek pengguna tidak valid:", userObject);
             handleLoginFailure("Data pengguna tidak lengkap.");
             return;
        }

        loginButtonContainer.innerHTML = '<p class="text-gray-600">Memverifikasi...</p>';
        loginError.classList.add('hidden');

        try {
            console.log("Memverifikasi pengguna:", userObject.email);
            // Ambil data pengguna jika belum ada atau jika sudah lama
            if (authorizedUsersData.length === 0) {
                 authorizedUsersData = await fetchData(USERS_SHEET_URL);
                 // Cek jika fetchData mengembalikan error status
                 if (!Array.isArray(authorizedUsersData)) {
                    // Jika ada properti status error dari fetchData, gunakan pesannya
                    throw new Error(authorizedUsersData.message || "Gagal mengambil data pengguna.");
                 }
            }
            
            const authorizedUser = authorizedUsersData.find(user => user.Email_Authorized && user.Email_Authorized.trim().toLowerCase() === userObject.email.toLowerCase());

            if (authorizedUser) {
                console.log("Pengguna terverifikasi:", userObject.email);
                currentUser = {
                    email: userObject.email,
                    name: userObject.name || authorizedUser.Nama_Pengguna || 'Pengguna', // Ambil nama dari token atau sheet
                    ormawa: authorizedUser.Ormawa_UKM 
                };
                sessionStorage.setItem('userEmail', currentUser.email);
                sessionStorage.setItem('userName', currentUser.name);
                await showDashboard(); // Pastikan dashboard ditampilkan setelah user diset
            } else {
                console.warn("Akses ditolak untuk:", userObject.email);
                handleLoginFailure('Akses ditolak. Email Anda tidak terdaftar.');
                // Logout paksa jika login sebelumnya tapi tidak valid lagi
                sessionStorage.clear(); 
            }
        } catch (error) {
            console.error("Error saat otorisasi:", error);
            handleLoginFailure(`Gagal memverifikasi: ${error.message}. Coba lagi nanti.`);
             sessionStorage.clear(); // Hapus sesi jika verifikasi gagal
        }
    }

    function handleLoginFailure(message) {
        loginError.textContent = message;
        loginError.classList.remove('hidden');
        // Pastikan tombol login muncul kembali jika belum ada
        if (!document.querySelector("#login-button-container > div")) {
             try {
                  google.accounts.id.renderButton(loginButtonContainer, { theme: "outline", size: "large" });
             } catch (e) { console.error("Gagal merender tombol login saat failure:", e); }
        }
        // Sembunyikan dashboard jika login gagal
        dashboardSection.classList.add('hidden'); 
        loginSection.style.display = 'block'; 
        publicTrackingSection.style.display = 'block'; 
    }
    
    // --- Logika Dasbor ---
    async function showDashboard() {
        // Pastikan currentUser sudah ada
        if (!currentUser) {
            console.error("currentUser belum diset saat showDashboard dipanggil.");
            handleLoginFailure("Sesi tidak valid, silakan login ulang.");
            return; 
        }
        
        console.log("Menampilkan dasbor untuk:", currentUser.email);
        loginSection.style.display = 'none';
        publicTrackingSection.style.display = 'none';
        dashboardSection.classList.remove('hidden'); // Gunakan classList untuk toggle display
        dashboardSection.style.display = 'block'; // Pastikan display block
        userGreeting.textContent = `Selamat datang, ${currentUser.name}!`;
        
        // Isi form dengan data pengguna saat ini
        try {
            document.getElementById('proposal-name').value = currentUser.name;
            document.getElementById('proposal-ormawa').value = currentUser.ormawa;
        } catch (e) { console.error("Gagal mengisi form:", e); }


        try {
            kanbanContainer.innerHTML = '<p class="text-gray-600 animate-pulse">Memuat data ajuan...</p>'; // Loading state
            allProposalsData = await fetchData(PROPOSALS_SHEET_URL);
            
             // Cek jika fetchData mengembalikan error status
             if (!Array.isArray(allProposalsData)) {
                throw new Error(allProposalsData.message || "Gagal mengambil data proposal.");
             }

            const userProposals = allProposalsData.filter(p => p.Email_Pengaju && p.Email_Pengaju.trim().toLowerCase() === currentUser.email.toLowerCase());
            console.log(`Menemukan ${userProposals.length} proposal untuk pengguna.`);
            renderKanbanBoard(userProposals);
        } catch (error) {
            console.error("Error saat mengambil atau render proposal:", error);
            kanbanContainer.innerHTML = `<p class="text-red-500">Gagal memuat data ajuan: ${error.message}. Coba muat ulang halaman.</p>`;
        }
    }

    // --- Render Papan Kanban ---
    function renderKanbanBoard(proposals) {
        kanbanContainer.innerHTML = ''; // Kosongkan papan
        
        // Buat objek untuk mengelompokkan proposal berdasarkan status
        const proposalsByStatus = {};
        Object.keys(statusConfig).forEach(status => proposalsByStatus[status] = []);
        
        // Masukkan proposal ke grup yang sesuai
        proposals.forEach(p => {
            const statusTrimmed = p.Status ? p.Status.trim() : null;
            if (statusTrimmed && proposalsByStatus[statusTrimmed] !== undefined) { // Check if key exists
                proposalsByStatus[statusTrimmed].push(p);
            } else if (statusTrimmed) {
                console.warn(`Status "${statusTrimmed}" dari proposal ${p.Proposal_ID} tidak dikenal atau tidak ada di statusConfig.`);
                // Opsional: Buat grup 'Lainnya' jika ada status tak dikenal
                if (!proposalsByStatus['Lainnya']) proposalsByStatus['Lainnya'] = { proposals: [], title: 'Status Lainnya', color: 'border-gray-500' };
                proposalsByStatus['Lainnya'].proposals.push(p);
            }
        });

        // Buat kolom untuk setiap status di statusConfig (dan grup 'Lainnya' jika ada)
        Object.keys(proposalsByStatus).forEach(statusKey => {
             // Handle grup 'Lainnya'
             const isOtherStatus = statusKey === 'Lainnya';
             const columnConfig = isOtherStatus ? proposalsByStatus[statusKey] : statusConfig[statusKey];
             const proposalsInColumn = isOtherStatus ? proposalsByStatus[statusKey].proposals : proposalsByStatus[statusKey];

             // Pastikan columnConfig ada (seharusnya selalu ada karena kita iterasi keys dari proposalsByStatus)
             if (!columnConfig) return; 

            const columnEl = document.createElement('div');
            // Sedikit penyesuaian lebar kolom agar lebih fleksibel
            columnEl.className = 'kanban-column flex-shrink-0 w-full sm:w-[48%] md:w-[31%] lg:w-[23%] xl:w-[19%]'; 
            columnEl.innerHTML = `<h3 class="font-heading text-lg font-bold text-gray-700 bg-gray-200 p-3 rounded-t-lg sticky top-0 z-10">${columnConfig.title}</h3><div class="p-4 bg-gray-100 rounded-b-lg space-y-4 h-[60vh] min-h-[250px] overflow-y-auto"></div>`; // Tinggi tetap & scroll
            
            const columnContent = columnEl.querySelector('div:last-child'); // Target div konten yang benar

            if (!proposalsInColumn || proposalsInColumn.length === 0) {
                columnContent.innerHTML = '<p class="text-sm text-gray-400 italic text-center pt-4">Tidak ada ajuan</p>';
            } else {
                // Urutkan proposal di kolom (misal berdasarkan Tgl_Diajukan terbaru)
                proposalsInColumn.sort((a, b) => {
                    try {
                        const dateA = a.Tgl_Diajukan ? new Date(a.Tgl_Diajukan) : new Date(0); // Fallback ke awal epoch
                        const dateB = b.Tgl_Diajukan ? new Date(b.Tgl_Diajukan) : new Date(0);
                        if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0; // Jangan sort jika tanggal tidak valid
                        return dateB - dateA; // Descending
                    } catch (e) {
                        return 0; 
                    }
                });

                proposalsInColumn.forEach(proposal => {
                    const card = document.createElement('div');
                    const borderColor = columnConfig.color || 'border-gray-500'; 
                    card.className = `bg-white p-4 rounded-md shadow border-l-4 ${borderColor} cursor-pointer hover:shadow-md transition-shadow duration-150`;
                    card.dataset.id = proposal.Proposal_ID;
                    const proposalTypeBadge = proposal.Jenis_Ajuan ? `<span class="text-xs font-semibold inline-block py-1 px-2.5 leading-none text-center whitespace-nowrap align-baseline bg-blue-100 text-blue-700 rounded-full mt-2">${proposal.Jenis_Ajuan}</span>` : '';
                    
                    card.innerHTML = `
                        <p class="text-xs text-gray-500 font-mono mb-1 truncate">${proposal.Proposal_ID || 'ID ?'}</p>
                        <p class="font-semibold text-gray-800 break-words leading-snug">${proposal.Judul_Proposal || 'Tanpa Judul'}</p>
                        <p class="text-sm text-gray-600 mt-1 truncate">${proposal.Ormawa_UKM || 'Ormawa ?'}</p>
                        ${proposalTypeBadge}
                    `;
                    card.addEventListener('click', () => showDetailsModal(proposal.Proposal_ID));
                    columnContent.appendChild(card);
                });
            }
            kanbanContainer.appendChild(columnEl);
        });
    }

    // --- Tampilkan Modal Detail ---
    function showDetailsModal(id) {
        const proposalData = allProposalsData.find(p => p.Proposal_ID === id);
        if (!proposalData) {
            console.error(`Proposal dengan ID ${id} tidak ditemukan di data.`);
            alert("Gagal memuat detail proposal.");
            return;
        }

        const statusTrimmed = proposalData.Status ? proposalData.Status.trim() : '';
        const isRevisionNeeded = statusTrimmed === "Perlu Revisi";
        const revisionButtonHTML = `
            <div class="mt-6 pt-4 border-t text-center">
                <p class="text-sm text-gray-600 mb-3">Setelah Anda memperbaiki dokumen, klik tombol di bawah ini untuk mengirim ulang proposal Anda untuk diverifikasi.</p>
                <button id="revision-submit-button" data-id="${proposalData.Proposal_ID}" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-full hover:bg-blue-700 transition-colors duration-200">
                    Konfirmasi Selesai Revisi & Ajukan Ulang
                </button>
                <p id="revision-submit-status" class="text-sm mt-2"></p> 
            </div>
        `;

        const content = `
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition-colors" onclick="closeAllModals()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="font-heading text-2xl font-bold text-[#0d47a1] mb-2">Detail Ajuan: ${proposalData.Proposal_ID || ''}</h3>
            <p class="text-lg text-gray-700 mb-6">${proposalData.Judul_Proposal || ''}</p>
            <div class="space-y-3 text-sm border-t pt-4">
              <p><strong>Ormawa/UKM:</strong> ${proposalData.Ormawa_UKM || '-'}</p>
              ${proposalData.Jenis_Ajuan ? `<p><strong>Jenis Ajuan:</strong> ${proposalData.Jenis_Ajuan}</p>` : ''}
              <p><strong>Tanggal Diajukan:</strong> ${formatDateTime(proposalData.Tgl_Diajukan)}</p>
              <p><strong>Status Saat Ini:</strong> <span class="font-semibold">${proposalData.Status || '-'}</span></p>
              ${proposalData.Link_Dokumen ? `<p><strong>Dokumen:</strong> <a href="${proposalData.Link_Dokumen}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Lihat & Perbaiki Dokumen</a></p>` : '<p><strong>Dokumen:</strong> Link tidak tersedia</p>'}
            </div>
            ${(proposalData.Catatan_Revisi && proposalData.Catatan_Revisi.trim()) ? `<div class="mt-4 pt-4 border-t"><p class="font-semibold text-gray-800 mb-2">Catatan Revisi:</p><p class="text-yellow-800 bg-yellow-100 p-3 rounded-md mt-1 text-sm">${proposalData.Catatan_Revisi}</p></div>` : ''}
            ${isRevisionNeeded ? revisionButtonHTML : ''}
        `;
        detailsModal.querySelector('.popup-content').innerHTML = content;
        
        // Tambahkan event listener jika tombol revisi ada
        if (isRevisionNeeded) {
            const revisionButton = document.getElementById('revision-submit-button');
             if (revisionButton) {
                  revisionButton.addEventListener('click', handleRevisionSubmit);
             } else {
                  console.error("Tombol revisi tidak ditemukan di DOM.");
             }
        }

        detailsModal.classList.remove('hidden');
    }
    
    // --- Tangani Pengajuan Ulang Revisi ---
    async function handleRevisionSubmit(event) {
        const button = event.target;
        const proposalId = button.dataset.id;
        const statusElement = document.getElementById('revision-submit-status'); // Elemen untuk menampilkan status

        button.textContent = 'Mengupdate...';
        button.disabled = true;
        button.classList.add('btn-disabled');
        if(statusElement) statusElement.textContent = ''; // Hapus status sebelumnya

        try {
            const response = await fetch(WEB_APP_BASE_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'text/plain;charset=utf-8', 
                },
                // Body tetap sama, mengirim ID dan status baru
                body: JSON.stringify({
                    proposalId: proposalId,
                    newStatus: 'Verifikasi Data' 
                })
            });

             // Error Handling Response
             if (!response.ok) {
                 let errorMsg = `HTTP error! status: ${response.status}`;
                 try {
                     const errBody = await response.text();
                     errorMsg += ` - ${errBody.substring(0, 100)}`; // Tampilkan sebagian body error
                 } catch {}
                 throw new Error(errorMsg);
             }
             if (!response.headers.get("content-type")?.includes("application/json")) {
                 const textResponse = await response.text();
                 throw new Error(`Respons server bukan JSON: ${textResponse.substring(0,100)}...`);
             }

            const result = await response.json();

            if (result.status === 'success') {
                 if(statusElement) {
                      statusElement.textContent = 'Berhasil! Proposal diajukan ulang.';
                      statusElement.className = 'text-sm mt-2 text-green-600';
                 }
                 setTimeout(async () => {
                     closeAllModals();
                     await showDashboard(); // Refresh dasbor
                 }, 1500);
            } else {
                // Gunakan pesan error dari server jika ada
                throw new Error(result.message || 'Gagal memperbarui status dari server.');
            }

        } catch (error) {
            console.error('Error saat mengajukan revisi:', error);
             if(statusElement) {
                  statusElement.textContent = `Gagal: ${error.message}`;
                  statusElement.className = 'text-sm mt-2 text-red-600';
             }
            // Aktifkan kembali tombol jika error
            button.textContent = 'Konfirmasi Selesai Revisi & Ajukan Ulang';
            button.disabled = false;
            button.classList.remove('btn-disabled');
        }
    }


    // --- Logika Pelacakan Publik ---
    async function trackPublicProposal() {
        const proposalID = proposalIdInput.value.trim().toUpperCase();
        if (!proposalID) {
            trackingResult.innerHTML = `<p class="text-red-500">Silakan masukkan ID Proposal yang valid.</p>`;
            return;
        }

        trackingResult.innerHTML = `<p class="text-gray-600 animate-pulse">Mencari proposal...</p>`; // Animasi loading

        try {
            // Selalu fetch data terbaru untuk tracking publik
            const allPublicProposals = await fetchData(PROPOSALS_SHEET_URL); 
             if (!Array.isArray(allPublicProposals)) {
                 // Jika fetch gagal, tampilkan pesan error
                throw new Error(allPublicProposals.message || "Gagal mengambil data proposal.");
             }
            
            const proposal = allPublicProposals.find(p => p.Proposal_ID && p.Proposal_ID.trim().toUpperCase() === proposalID);

            if (proposal) {
                const statusTrimmed = proposal.Status ? proposal.Status.trim() : 'Status Tidak Diketahui';
                const statusInfo = statusConfig[statusTrimmed] || {color: 'border-gray-500', title: statusTrimmed }; 
                
                trackingResult.innerHTML = `
                    <div class="bg-gray-50 border-l-4 ${statusInfo.color} p-5 rounded-lg text-left shadow">
                        <p class="font-bold text-lg text-gray-800 mb-1">${proposal.Judul_Proposal || 'Judul Tidak Tersedia'}</p>
                        <p class="text-sm text-gray-600">${proposal.Ormawa_UKM || 'Ormawa Tidak Tersedia'}</p>
                        ${proposal.Jenis_Ajuan ? `<p class="mt-3 text-sm"><strong>Jenis Ajuan:</strong> ${proposal.Jenis_Ajuan}</p>` : ''}
                        <p class="mt-3 text-sm"><strong>Tanggal Diajukan:</strong> ${formatDateTime(proposal.Tgl_Diajukan)}</p>
                        <p class="mt-2 text-sm"><strong>Status Saat Ini:</strong> <span class="font-semibold text-gray-900">${statusInfo.title}</span></p>
                         ${proposal.Catatan_Revisi && statusTrimmed === 'Perlu Revisi' ? `<div class="mt-3 pt-3 border-t border-gray-200"><p class="text-sm font-semibold text-gray-800 mb-1">Catatan Revisi:</p><p class="text-sm text-yellow-800 bg-yellow-100 p-2 rounded">${proposal.Catatan_Revisi}</p></div>` : ''}
                    </div>
                `;
            } else {
                trackingResult.innerHTML = `<p class="text-red-600">Proposal dengan ID "${proposalID}" tidak ditemukan.</p>`;
            }
        } catch (error) {
            console.error("Error saat pelacakan publik:", error);
            trackingResult.innerHTML = `<p class="text-red-600">Gagal mengambil data: ${error.message}. Coba lagi nanti.</p>`;
        }
    }


    // --- Logika Modal ---
    function openNewProposalModal() { 
        // Reset form sebelum dibuka
        newProposalForm.reset(); 
         if (currentUser) {
            try { // Tambah try-catch untuk elemen yg mungkin belum ada
                 document.getElementById('proposal-name').value = currentUser.name;
                 document.getElementById('proposal-ormawa').value = currentUser.ormawa;
            } catch (e) {console.error("Elemen form tidak ditemukan saat openNewProposalModal:", e)}
         }
        newProposalModal.classList.remove('hidden'); 
    }
    function closeAllModals() {
        newProposalModal.classList.add('hidden');
        detailsModal.classList.add('hidden');
    }

    // --- Pengajuan Form Proposal Baru ---
    newProposalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Validasi
        const name = document.getElementById('proposal-name').value;
        const title = document.getElementById('proposal-title').value;
        const ormawa = document.getElementById('proposal-ormawa').value;
        const linkInput = document.getElementById('proposal-link');
        const link = linkInput.value;
        const typeSelect = document.getElementById('proposal-type');
        const type = typeSelect.value; 

        if (!name || !title || !ormawa || !link || !type) {
            alert("Harap lengkapi semua field sebelum mengajukan.");
            return;
        }
        // Validasi URL sederhana
        try {
           new URL(link);
        } catch (_) {
           alert("Link Dokumen Proposal tidak valid. Pastikan menggunakan http:// atau https://");
           linkInput.focus();
           return;
        }
        
        // Cek jika ID entry type sudah diganti
        if (GOOGLE_FORM_ENTRIES.type === 'ENTRY_ID_JENIS_AJUAN_ANDA') {
             alert("Konfigurasi error: ID Entry untuk Jenis Ajuan belum diatur dalam kode JavaScript.");
             return; 
        }

        // Pastikan currentUser ada sebelum mengambil email
        if (!currentUser || !currentUser.email) {
            alert("Sesi pengguna tidak ditemukan. Silakan login ulang.");
            // Arahkan ke login atau refresh?
            location.reload(); 
            return;
        }


        const prefilledUrl = `${GOOGLE_FORM_PREFILL_URL}?usp=pp_url` +
                             `&${GOOGLE_FORM_ENTRIES.name}=${encodeURIComponent(name)}` +
                             `&${GOOGLE_FORM_ENTRIES.title}=${encodeURIComponent(title)}` +
                             `&${GOOGLE_FORM_ENTRIES.ormawa}=${encodeURIComponent(ormawa)}` +
                             `&${GOOGLE_FORM_ENTRIES.link}=${encodeURIComponent(link)}` +
                             `&${GOOGLE_FORM_ENTRIES.email}=${encodeURIComponent(currentUser.email)}` + 
                             `&${GOOGLE_FORM_ENTRIES.type}=${encodeURIComponent(type)}`; 

        console.log("Membuka URL Prefill:", prefilledUrl); // Log URL untuk debugging
        window.open(prefilledUrl, '_blank');
        
        closeAllModals(); 
        // Tidak perlu reset form lagi di sini karena sudah direset saat modal dibuka
    });


    // --- Fungsi Utilitas ---
    function formatDateTime(dateInput) {
        if (!dateInput || String(dateInput).trim() === '') return 'Tidak ada tanggal';
        try {
            // Coba parsing sebagai ISO 8601 dulu (format paling umum dari API/Sheet)
            let date = new Date(dateInput);
            
            // Jika ISO gagal, coba format DD/MM/YYYY HH:MM atau variasinya
            if (isNaN(date.getTime())) {
                 const parts = String(dateInput).split(/[\/\- :]/); 
                 if (parts.length >= 3) {
                      // Hati-hati asumsi DD/MM vs MM/DD. Coba DD/MM dulu.
                      const day = parseInt(parts[0], 10);
                      const month = parseInt(parts[1], 10) - 1; // Month 0-indexed
                      let year = parseInt(parts[2], 10);
                      // Handle tahun 2 digit (misal '25' -> 2025) - Hati-hati ambiguitas
                      if (year < 100) { year += 2000; } 
                      
                      let hours = 0, minutes = 0, seconds = 0;
                      if (parts.length >= 5) {
                           hours = parseInt(parts[3], 10) || 0;
                           minutes = parseInt(parts[4], 10) || 0;
                      }
                      if (parts.length >= 6) {
                            seconds = parseInt(parts[5], 10) || 0;
                      }
                      
                      // Buat objek Date dari parts
                      date = new Date(Date.UTC(year, month, day, hours, minutes, seconds)); // Gunakan UTC untuk konsistensi

                      // Validasi ulang setelah parsing alternatif
                      if (isNaN(date.getTime())) {
                          console.warn("Gagal mem-parsing tanggal (format alternatif):", dateInput);
                          return String(dateInput); // Kembalikan string asli jika semua gagal
                      }
                 } else {
                      console.warn("Gagal mem-parsing tanggal (tidak cukup parts):", dateInput);
                      return String(dateInput); // Kembalikan string asli jika format aneh
                 }
            }
            
            // Format output jika parsing berhasil
            // Gunakan toLocaleString untuk format lokal (lebih fleksibel)
            return date.toLocaleString('id-ID', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false // Format 24 jam
            }).replace(/\./g, ':'); // Ganti titik pemisah waktu jadi :

        } catch (error) {
            console.error("Error saat format tanggal:", dateInput, error);
            return String(dateInput); // Kembalikan string asli jika ada error tak terduga
        }
    }

    // Fungsi Fetch dengan penanganan error lebih baik
   async function fetchData(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                let errorBody = `HTTP error ${response.status}`;
                try { 
                    const text = await response.text();
                    // Coba ekstrak pesan error dari HTML Apps Script jika ada
                     if (text.includes('<title>Error')) {
                         const match = text.match(/<pre>.*?<\/pre>/s);
                         errorBody = `Apps Script Error: ${match ? match[0].replace(/<\/?pre>/g,'').trim() : 'Detail tidak tersedia'}`;
                     } else {
                          errorBody += `: ${text.substring(0, 150)}`; // Tampilkan potongan body
                     }
                } catch (e) { /* Abaikan jika body tidak bisa dibaca */ }
                throw new Error(errorBody);
            }
            
             if (!response.headers.get("content-type")?.includes("application/json")) {
                 const textResponse = await response.text();
                 throw new Error(`Respons bukan JSON: ${textResponse.substring(0, 100)}...`);
            }

            const data = await response.json();
            if (data && data.status === 'error') {
                throw new Error(`API Error: ${data.message}`);
            }
            // Pastikan data yang dikembalikan adalah array jika sukses (untuk users/proposals)
            if (url.includes('sheet=users') || url.includes('sheet=proposals')) {
                 if (!Array.isArray(data)) {
                      console.warn("Data diterima tapi bukan array:", data);
                      return []; // Kembalikan array kosong jika format tidak sesuai
                 }
            }
            return data; 
        } catch (error) {
            console.error(`Fetch error dari ${url}:`, error);
            // Kembalikan objek error agar bisa ditangani
            return { status: 'error', message: error.message }; 
        }
    }

    // --- Event Listeners Global ---
    newProposalButton.addEventListener('click', openNewProposalModal);
    closeNewProposalModal.addEventListener('click', closeAllModals);
    cancelProposalButton.addEventListener('click', closeAllModals);
    trackProposalButton.addEventListener('click', trackPublicProposal);
    logoutButton.addEventListener('click', () => {
        console.log("Logout initiated...");
        sessionStorage.clear();
        currentUser = null;
        try {
            google.accounts.id.disableAutoSelect();
            google.accounts.id.revoke(sessionStorage.getItem('userEmail') || '', done => {
                console.log('Google session revoked.');
                 // Render ulang tombol login setelah logout komplit
                 loginButtonContainer.innerHTML = ''; 
                 google.accounts.id.renderButton(loginButtonContainer, { theme: "outline", size: "large" });
                 dashboardSection.classList.add('hidden');
                 loginSection.style.display = 'block';
                 publicTrackingSection.style.display = 'block';
                 // location.reload(); // Mungkin tidak perlu jika UI diupdate manual
            });
        } catch (e) {
            console.error("Error during Google logout:", e);
             // Tetap lanjutkan proses logout UI
             loginButtonContainer.innerHTML = ''; 
             try { google.accounts.id.renderButton(loginButtonContainer, { theme: "outline", size: "large" }); } catch {}
             dashboardSection.classList.add('hidden');
             loginSection.style.display = 'block';
             publicTrackingSection.style.display = 'block';
        }
    });
    // Tutup modal jika klik di luar
    detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeAllModals(); });
    newProposalModal.addEventListener('click', (e) => { if (e.target === newProposalModal) closeAllModals(); });

     // Lacak saat menekan Enter di input ID
     proposalIdInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Cegah submit form jika ada
            trackPublicProposal();
        }
    });

});
</script>

</body>
</html>

